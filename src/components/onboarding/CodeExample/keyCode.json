{
  "node": [
    "const fetch = require('node-fetch');",
    "const jwt = require('jsonwebtoken');",
    "const fs = require('fs');",
    "const crypto = require('crypto');",
    "",
    "// Variables from integration",
    "const kid = '__KID__';",
    "const integration_id = '__CLIENT_ID__';",
    "const scope = '__SCOPE__';",
    "",
    "// Environment specific variables",
    "const maskinporten_audience = '__MASKINPORTEN_URL__';",
    "const maskinporten_token_url = '__MASKINPORTEN_TOKEN_URL__';",
    "",
    "const jwt_token = jwt.sign(",
    "  {",
    "    scope: scope,",
    "    // resource: '' <-- if resource is needed for this API",
    "  }, {",
    "    key: fs.readFileSync('[PATH_TO_PRIVATE_KEY_PEM]'),",
    "    //passphrase: '[PASSWORD]' <-- if password needed",
    "  }, {",
    "    algorithm: 'RS256',",
    "    audience: maskinporten_audience,",
    "    issuer: integration_id,",
    "    header: {kid: kid},",
    "    expiresIn: 100,",
    "    jwtid: crypto.randomUUID()",
    "  }",
    ");",
    "",
    "const params = new URLSearchParams();",
    "params.append('grant_type', 'urn:ietf:params:oauth:grant-type:jwt-bearer');",
    "params.append('assertion', jwt_token);",
    "",
    "fetch(maskinporten_token_url, {",
    "  method: 'post',",
    "  headers: {'Content-Type': 'application/x-www-form-urlencoded'},",
    "  body: params",
    "})",
    ".then(res => res.json())",
    ".then(data => process.stdout.write(JSON.stringify(data)))"
  ],
  "java": [
    "package no.difi.oauth2.utils;",
    "",
    "import com.nimbusds.jose.JWSAlgorithm;",
    "import com.nimbusds.jose.JWSHeader;",
    "import com.nimbusds.jose.JWSSigner;",
    "import com.nimbusds.jose.crypto.RSASSASigner;",
    "import com.nimbusds.jwt.JWTClaimsSet;",
    "import com.nimbusds.jwt.SignedJWT;",
    "import org.apache.hc.client5.http.fluent.Form;",
    "import org.apache.hc.client5.http.fluent.Request;",
    "import org.apache.hc.client5.http.fluent.Response;",
    "import org.apache.hc.core5.http.ContentType;",
    "import org.apache.hc.core5.http.HttpEntity;",
    "import org.apache.hc.core5.http.io.entity.EntityUtils;",
    "import org.apache.hc.core5.http.message.BasicClassicHttpResponse;",
    "import java.io.FileInputStream;",
    "import java.security.KeyStore;",
    "import java.security.PrivateKey;",
    "import java.time.Clock;",
    "import java.util.Date;",
    "import java.util.List;",
    "import java.util.UUID;",
    "",
    "public class AsymmetricKeyJwtGrantGenerator {",
    "",
    "",
    "    public static void main(String[] args) throws Exception {",
    "",
    "        // Variable som kommer fra integrasjonen",
    "        String key_id = \"__KID__\"; // Key id (kid)",
    "        String integrasjonsid = \"__CLIENT_ID__\";",
    "        String scope = \"__SCOPE__\";",
    "",
    "        // Variable som avhengiger av miljø",
    "        String maskinportenAudience = \"__MASKINPORTEN_URL__\";",
    "        String maskinportenTokenUrl = \"__MASKINPORTEN_TOKEN_URL__\";",
    "",
    "        // Variable som avhenger av APIet du skal autentisere mot",
    "        String targetApiAudience = \"<your intended audience>\"; // Sjekk API-tilbyder om de spesifiserer en verdi for denne",
    "",
    "        // Variable som er tilpasset din keystore hvor du har lagt privatnøkkelen",
    "        String keyStoreType = \"PKCS12\";",
    "        String keystorepassword = \"keystorepassword\";",
    "        String pathToKeystore = \"pathToKeystore\";",
    "        String aliasToPrivatekey = \"privatekey-alias\";",
    "        String aliasPassword = \"aliaspassword\";",
    "",
    "",
    "        KeyStore keyStore = KeyStore.getInstance(keyStoreType);",
    "        keyStore.load(new FileInputStream(pathToKeystore), keystorepassword.toCharArray());",
    "",
    "        JWSHeader jwtHeader = new JWSHeader.Builder(JWSAlgorithm.RS256)",
    "                .keyID(key_id)",
    "                .build();",
    "",
    "        JWTClaimsSet claims = new JWTClaimsSet.Builder()",
    "                .audience(maskinportenAudience)",
    "                .issuer(integrasjonsid)",
    "                .claim(\"scope\", scope)",
    "                .claim(\"resource\", targetApiAudience)",
    "                .jwtID(UUID.randomUUID().toString()) // Must be unique for each grant",
    "                .issueTime(new Date(Clock.systemUTC().millis())) // Use UTC time",
    "                .expirationTime(new Date(Clock.systemUTC().millis() + 120000)) // Expiration time is 120 sec",
    "                .build();",
    "",
    "        PrivateKey privateKey = (PrivateKey) keyStore.getKey(aliasToPrivatekey, aliasPassword.toCharArray());",
    "        JWSSigner signer = new RSASSASigner(privateKey);",
    "        SignedJWT signedJWT = new SignedJWT(jwtHeader, claims);",
    "        signedJWT.sign(signer);",
    "",
    "        String jwt = signedJWT.serialize();",
    "",
    "        List body = Form.form()",
    "                .add(\"grant_type\", \"urn:ietf:params:oauth:grant-type:jwt-bearer\")",
    "                .add(\"assertion\", jwt)",
    "                .build();",
    "        try {",
    "            Response response = Request.post(maskinportenTokenUrl)",
    "                    .addHeader(\"Content-Type\", ContentType.APPLICATION_FORM_URLENCODED.toString())",
    "                    .bodyForm(body)",
    "                    .execute();",
    "",
    "            HttpEntity e = ((BasicClassicHttpResponse) response.returnResponse()).getEntity();",
    "            String result = EntityUtils.toString(e);",
    "            System.out.println(result);",
    "",
    "            // Use access_token in result as authentication header to the service you wish to connect to",
    "",
    "        } catch (Exception e) {",
    "            e.printStackTrace();",
    "        }",
    "",
    "    }",
    "}",
    ""
  ],
  "dependencies": {
    "java": {
      "maven": {
        "code": [
          "<dependency>",
          "    <groupId>com.nimbusds</groupId>",
          "    <artifactId>nimbus-jose-jwt</artifactId>",
          "    <version>9.31</version>",
          "</dependency>",
          "<dependency>",
          "    <groupId>org.apache.httpcomponents.client5</groupId>",
          "    <artifactId>httpclient5-fluent</artifactId>",
          "    <version>5.2.1</version>",
          "</dependency>",
          "<dependency>",
          "    <groupId>org.slf4j</groupId>",
          "    <artifactId>slf4j-log4j12</artifactId>",
          "    <version>1.6.6</version>",
          "</dependency>"
        ],
        "lang": "xml",
        "name": "Maven",
        "id": "maven"
      },
      "gradle": {
        "code": [
          "implementation \"com.nimbusds:nimbus-jose-jwt:9.31\"",
          "implementation \"org.apache.httpcomponents.client5:httpclient5-fluent:5.2.1\"",
          "implementation \"org.slf4j:slf4j-log4j12:1.6.6\""
        ],
        "lang": "gradle",
        "name": "Gradle",
        "id": "gradle"
      }
    },
    "python": {
      "pip": {
        "code": [
          "pip install requests",
          "pip install uuid",
          "pip install jwcrypto"
        ],
        "lang": "shell",
        "name": "PIP",
        "id": "pip"
      }
    },
    "node": {
      "npm": {
        "code": ["npm install node-fetch", "npm install jsonwebtoken"],
        "lang": "shell",
        "name": "NPM",
        "id": "npm"
      }
    }
  },
  "python": [
    "import requests",
    "import uuid",
    "from jwcrypto import jwk, jwt",
    "from datetime import datetime, timezone",
    "",
    "# Variables from integration",
    "kid = \"__KID__\"",
    "scope = \"__SCOPE__\"",
    "integration_id = \"__CLIENT_ID__\"",
    "",
    "# Environment specific variables",
    "maskinporten_audience = \"__MASKINPORTEN_URL__\"",
    "maskinporten_token = \"__MASKINPORTEN_TOKEN_URL__\"",
    "",
    "timestamp = int(datetime.now(timezone.utc).timestamp())",
    "",
    "with open('[PRIVATE_KEY_PEM]', mode='rb') as f:",
    "  key = jwk.JWK.from_pem(",
    "  data=f.read(),",
    "  #password=str('PASSWORD').encode() <-- if password needed",
    ")",
    "f.closed",
    "",
    "",
    "jwt_header = {",
    "  'alg': 'RS256',",
    "  'kid': kid",
    "}",
    "",
    "jwt_claims = {",
    "  'aud': maskinporten_audience,",
    "  'iss': integration_id,",
    "  'scope': scope,",
    "  #'resource': '', <-- if resource is needed for your specific API",
    "  'iat': timestamp,",
    "  'exp': timestamp+100,",
    "  'jti': str(uuid.uuid4())",
    "}",
    "",
    "jwt_token = jwt.JWT(",
    "  header = jwt_header,",
    "  claims = jwt_claims,",
    ")",
    "jwt_token.make_signed_token(key)",
    "signed_jwt = jwt_token.serialize()",
    "",
    "body = {",
    "  'grant_type': 'urn:ietf:params:oauth:grant-type:jwt-bearer',",
    "  'assertion': signed_jwt",
    "}",
    "",
    "res = requests.post(maskinporten_token, data=body)",
    "print(res.text)"
  ]
}
